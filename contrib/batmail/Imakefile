/* Imakefile for batmail package

	Batmail provides a gnu-emacs front-end to Andrew mail

    installs these files in $DESTDIR
	/bin/     robin batmail.sh
	/help/    ${HELPFILES}
	/lib/el/  batmail.el prompt.el
	/lib/ml/  batmail.ml prompt.ml
	/etc/	  intro intro.small initscreen
*/


BATCAVE =   ${DESTDIR}

BATDIRS=    $(BATCAVE) $(BATCAVE)/bin $(BATCAVE)/etc \
	$(BATCAVE)/lib   $(BATCAVE)/lib/ml $(BATCAVE)/lib/el \
	$(BATCAVE)/help 

OBJS=       robin.o lispint.o driver.o date.o headfilter.o unscribe.o \
	hash.o wrap.o xsqiggle.o split.o lcstring.o \
	parseaddr.o falias.o death.o lock.o hshbuf.o rewrite.o fakedom.o 

HELPFILES =  batmail.1 overview.gnu  files.both  variables.gnu hooks.gnu \
	variables.gos hooks.gos commands.gos mcommands.gos


NormalObjectRule()
NormalATKRule()
NormalHelpRule()

ATKLIB =    $(BASEDIR)/lib
LIBRXP=	    ${ATKLIB}/librxp.a
LIBCUIN=    $(ATKLIB)/libcui.a $(ATKLIB)/libcuin.a
LIBMSN=	    $(ATKLIB)/libmssrv.a $(ATKLIB)/libmsshr.a
LIBMAIL=    $(ATKLIB)/libmail.a
LIBFLAME=   ${ATKLIB}/libeli.a
LIBPARSER=  ${ATKLIB}/libcparser.a
AMSLIBS =  $(LIBRXP) $(LIBCUIN) $(LIBMSN) $(LIBMAIL) $(LIBFLAME)  $(ATKLIB)/liberrors.a  ${LIBPARSER}

LOCALINCLUDES = -I$(BASEDIR)/include/ams

ProgramTarget(robin,$(OBJS),$(AMSLIBS) $(UTILLIB) ${PRSLIB},) 

batmail.sh: batmail.sh.sht
	sed s%@EMACSNAME@%GNUEMACS% batmail.sh.sht > batmail.sh


/* ------------------------- */

tests.time: testre testdate testdeath unscribe testhf
	touch tests.time

TestProgramTarget(testre,testre.o,,$(BASEDIR)/lib/librxp.a)
TestProgramTarget(testdate,testdate.o date.o lcstring.o,,$(UTILLIB))
TestProgramTarget(testdeath,testdeath.o ${OBJS},,$(UTILLIB))
TestProgramTarget(unscribe,unscribemain.o unscribe.o hash.o lcstring.o,,)
TestProgramTarget(testhf,testhf.o headfilter.o hash.o split.o lcstring.o,,)

/* ------------------------- */

/* Installation */
MkdirTarget($(BATDIRS))
InstallPrograms(robin,${BATCAVE}/bin)
InstallDocs($(HELPFILES),$(BATCAVE)/help)
InstallHelpAlias(batmail,batmail robin)
InstallFiles(intro intro.small initscreen, $(INSTAPPFLAGS), $(BATCAVE)/etc)
InstallShScript(batmail.sh, $(BATCAVE)/bin/batmail)
InstallFiles(batmail.ml prompt.ml, $(INSTAPPFLAGS), $(BATCAVE)/lib/ml)
InstallFiles(batmail.el prompt.el, $(INSTAPPFLAGS), $(BATCAVE)/lib/el)

#define BYTECOMPILE(name) 						@@\
install.time:: $(BATCAVE)/lib/el/name.elc						@@\
$(BATCAVE)/lib/el/name.elc: $(BATCAVE)/lib/el/name.el		@@\
	@sh -c 'if [ -x $(GNUEMACS) ]; then \ 				@@\
		cd $(BATCAVE)/lib/el ; PWD=`pwd` export PWD ; \		@@\
	  	$(GNUEMACS) -batch -f batch-byte-compile name.el ;  \		@@\
	fi ; \ 						@@\
	exit 0'

BYTECOMPILE(batmail)
BYTECOMPILE(prompt)

CleanTarget(batmail.sh)
